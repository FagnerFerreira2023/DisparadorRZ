version: "3.7"
services:

  disparadorrz_api:
    image: ghcr.io/fagnerferreira2023/disparadorrz:latest

    volumes:
      - disparadorrz_auth_teste8:/app/auth

    networks:
      - Activa_Rede

    environment:
      - NODE_ENV=production
      - PORT=8787
      - AUTH_FOLDER=auth
      - JWT_SECRET=2b7e1c8e4a9f4b6e8c2d1a7e3f6b9c4d5e7a2b1c3d4e5f6a7b8c9d0e1f2a3b4c
      - JWT_REFRESH_SECRET=9c8b7a6e5d4c3b2a1f0e9d8c7b6a5e4d3c2b1a0f9e8d7c6b5a4e3d2c1b0a9f8
      - DB_HOST=disparadorrz_postgres_teste8
      - DB_PORT=5432
      - DB_NAME=rz_sender_teste8
      - DB_USER=rz_sender_teste8
      - DB_PASSWORD=Jw8kL2pQz5Vb6Xy7Tn3Rz1Qw9Sx8Yz2A
      - API_KEY=
    command: ["sh", "-c", "if [ -f dist/db/schema.sql ]; then node dist/db/migrate.js || echo '[STARTUP] migrate falhou, seguindo'; else echo '[STARTUP] schema.sql não encontrado, pulando migrate'; fi; if [ -f dist/db/seed.js ]; then node dist/db/seed.js || echo '[STARTUP] seed falhou, seguindo'; else echo '[STARTUP] seed.js não encontrado, pulando seed'; fi; node dist/index.js"]
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=1
        - traefik.http.routers.disparadorrz_teste8.rule=Host(`disparadorteste8.pizzbot.cloud`)
        - traefik.http.routers.disparadorrz_teste8.entrypoints=websecure
        - traefik.http.routers.disparadorrz_teste8.priority=1
        - traefik.http.routers.disparadorrz_teste8.tls.certresolver=letsencryptresolver
        - traefik.http.routers.disparadorrz_teste8.service=disparadorrz_teste8
        - traefik.http.services.disparadorrz_teste8.loadbalancer.server.port=8787
        - traefik.http.services.disparadorrz_teste8.loadbalancer.passHostHeader=true

  disparadorrz_postgres_teste8:
    image: postgres:15-alpine
    volumes:
      - disparadorrz_postgres_data_teste8:/var/lib/postgresql/data
    networks:
      - Activa_Rede
    environment:
      - POSTGRES_USER=rz_sender_teste8
      - POSTGRES_PASSWORD=Jw8kL2pQz5Vb6Xy7Tn3Rz1Qw9Sx8Yz2A
      - POSTGRES_DB=rz_sender_teste8
    deploy:
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "1"
          memory: 1024M

volumes:
  disparadorrz_auth_teste8:
  disparadorrz_postgres_data_teste8:

networks:
  Activa_Rede:
    external: true
    name: Activa_Rede
